# 消融实验说明文档

## 一、实验目标

验证 BWGNN-ResAFA 模型中三个核心组件的必要性：
1. **残差注意力（Residual Attention）**：`H_out = H_in * (1 + tanh(MLP(H_in)))`
2. **LayerNorm**：稳定训练过程中的特征分布
3. **加权拼接（Weighted Concatenation）**：保留所有频率维度信息

## 二、实验设计

### 2.1 Amazon 数据集（同构 ResAFA）

| 变体名称 | 残差注意力 | LayerNorm | 聚合方式 | 模型名称 |
|---------|----------|-----------|---------|---------|
| **完整 ResAFA** | ✅ | ✅ | 拼接 | `BWGNN_AFA` |
| **NoResidual** | ❌ | ✅ | 拼接 | `BWGNN_AFA_NoResidual` |
| **NoLayerNorm** | ✅ | ❌ | 拼接 | `BWGNN_AFA_NoLayerNorm` |
| **Sum** | ✅ | ✅ | 求和 | `BWGNN_AFA_Sum` |

### 2.2 YelpChi 数据集（异构 ResAFA）

| 变体名称 | 残差注意力 | LayerNorm | 聚合方式 | 模型名称 |
|---------|----------|-----------|---------|---------|
| **完整 ResAFA** | ✅ | ✅ | 拼接 | `BWGNN_HETERO_AFA` |
| **NoResidual** | ❌ | ✅ | 拼接 | `BWGNN_HETERO_AFA_NoResidual` |
| **NoLayerNorm** | ✅ | ❌ | 拼接 | `BWGNN_HETERO_AFA_NoLayerNorm` |
| **Sum** | ✅ | ✅ | 求和 | `BWGNN_HETERO_AFA_Sum` |

## 三、训练命令

### 3.1 Amazon 数据集消融实验

```bash
# 1. 完整 ResAFA（基线）
python main.py --dataset amazon --homo 1 --epoch 100 --order 2 --hid_dim 64 --model BWGNN_AFA --dropout 0.0

# 2. 去掉残差结构
python main.py --dataset amazon --homo 1 --epoch 100 --order 2 --hid_dim 64 --model BWGNN_AFA_NoResidual --dropout 0.0

# 3. 去掉 LayerNorm
python main.py --dataset amazon --homo 1 --epoch 100 --order 2 --hid_dim 64 --model BWGNN_AFA_NoLayerNorm --dropout 0.0

# 4. 改用求和
python main.py --dataset amazon --homo 1 --epoch 100 --order 2 --hid_dim 64 --model BWGNN_AFA_Sum --dropout 0.0
```

### 3.2 YelpChi 数据集消融实验

```bash
# 1. 完整 ResAFA（基线）
python main.py --dataset yelp --homo 0 --epoch 150 --train_ratio 0.4 --model BWGNN_HETERO_AFA --dropout 0.3

# 2. 去掉残差结构
python main.py --dataset yelp --homo 0 --epoch 150 --train_ratio 0.4 --model BWGNN_HETERO_AFA_NoResidual --dropout 0.3

# 3. 去掉 LayerNorm
python main.py --dataset yelp --homo 0 --epoch 150 --train_ratio 0.4 --model BWGNN_HETERO_AFA_NoLayerNorm --dropout 0.3

# 4. 改用求和
python main.py --dataset yelp --homo 0 --epoch 150 --train_ratio 0.4 --model BWGNN_HETERO_AFA_Sum --dropout 0.3
```

## 四、输出文件

所有消融实验的输出格式与正常实验完全一致：

### 模型文件
- `models/best_model_{dataset}_{Model}_{Homo|Hetero}.pth` - 最佳模型权重
- `models/best_probs_{dataset}_{Model}_{Homo|Hetero}.pkl` - 最佳预测结果

### 指标文件
- `metrics/training_metrics_{dataset}_{Model}_{Homo|Hetero}.json` - 训练指标数据

### 可视化文件（训练后生成）
- `figures/training_metrics_{dataset}_{Model}_{Homo|Hetero}.png` - 训练曲线
- `figures/test_metrics_summary_{dataset}_{Model}_{Homo|Hetero}.png` - 指标汇总

### 结果记录
- `result.txt` - 文本结果记录（自动追加）

## 五、预期结果分析

### 5.1 残差注意力（Residual Attention）

**预期影响**：
- 去掉残差后，模型可能失去"保底性能"，AUC 和 Recall 可能下降
- 验证残差结构 `(1 + attn_delta)` 对保持原始性能的重要性

**对比指标**：
- ResAFA vs ResAFA-NoResidual

### 5.2 LayerNorm

**预期影响**：
- 去掉 LayerNorm 后，训练可能不稳定，性能可能略有下降
- 验证 LayerNorm 对稳定异构图中节点度分布的重要性

**对比指标**：
- ResAFA vs ResAFA-NoLayerNorm

### 5.3 加权拼接（Weighted Concatenation）

**预期影响**：
- 改用求和后，频率信息被压缩，可能出现信息瓶颈
- AUC 可能下降（参考 Phase 2 实验：AUC 从 98.16% 降至 96.61%）

**对比指标**：
- ResAFA vs ResAFA-Sum

## 六、结果汇总表格模板

实验完成后，请按以下格式汇总结果：

### Amazon 数据集（同构 ResAFA）

| 模型变体 | Recall | Precision | F1-Macro | AUC | 相对完整 ResAFA |
|---------|--------|-----------|----------|-----|----------------|
| ResAFA (完整) | 85.15% | 90.06% | 93.14% | 97.82% | Baseline |
| ResAFA-NoResidual | - | - | - | - | - |
| ResAFA-NoLayerNorm | - | - | - | - | - |
| ResAFA-Sum | - | - | - | - | - |

### YelpChi 数据集（异构 ResAFA）

| 模型变体 | Recall | Precision | F1-Macro | AUC | 相对完整 ResAFA |
|---------|--------|-----------|----------|-----|----------------|
| ResAFA (完整) | 66.95% | 51.46% | 74.90% | 88.60% | Baseline |
| ResAFA-NoResidual | - | - | - | - | - |
| ResAFA-NoLayerNorm | - | - | - | - | - |
| ResAFA-Sum | - | - | - | - | - |

## 七、注意事项

1. **训练顺序**：建议先训练完整 ResAFA 作为基线，再依次训练各消融变体
2. **随机种子**：所有实验使用相同的随机种子（717），确保可复现性
3. **超参数**：消融实验使用与完整 ResAFA 相同的超参数设置
4. **时间成本**：每个变体训练时间约 1-2 小时（Amazon）或 2-3 小时（YelpChi）
5. **结果记录**：训练完成后，结果会自动追加到 `result.txt`，可直接查看

## 八、可视化

训练完成后，可使用以下命令生成可视化图表：

```bash
# Amazon 数据集
python visualize_training.py --dataset amazon --homo 1 --model BWGNN_AFA
python visualize_training.py --dataset amazon --homo 1 --model BWGNN_AFA_NoResidual
python visualize_training.py --dataset amazon --homo 1 --model BWGNN_AFA_NoLayerNorm
python visualize_training.py --dataset amazon --homo 1 --model BWGNN_AFA_Sum

# YelpChi 数据集
python visualize_training.py --dataset yelp --homo 0 --model BWGNN_HETERO_AFA
python visualize_training.py --dataset yelp --homo 0 --model BWGNN_HETERO_AFA_NoResidual
python visualize_training.py --dataset yelp --homo 0 --model BWGNN_HETERO_AFA_NoLayerNorm
python visualize_training.py --dataset yelp --homo 0 --model BWGNN_HETERO_AFA_Sum
```

## 九、实验完成后的工作

1. **结果汇总**：将各变体的结果填入上述表格模板
2. **结果分析**：分析每个组件对性能的影响
3. **报告撰写**：在报告中添加"消融实验分析"章节
4. **结果提交**：将结果发送给项目负责人进行进一步分析

---

**最后更新**：2025.12.30  
**文档版本**：v1.0

